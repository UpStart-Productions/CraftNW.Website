---
interface Props {
  images: string[];
  alt: string;
}

const { images, alt } = Astro.props;

// Generate a unique ID for this carousel instance
const carouselId = `product-carousel-${Math.random().toString(36).substr(2, 9)}`;
---

<div data-carousel-id={carouselId}>
  <!-- Images -->
  <div class="relative aspect-square overflow-hidden bg-craft-tan">
    {images.map((image, index) => (
      <div
        class={`product-carousel-image absolute inset-0 transition-opacity duration-500 ${index === 0 ? 'opacity-100' : 'opacity-0'}`}
        data-index={index}
      >
        <img
          src={image}
          alt={`${alt} - Image ${index + 1}`}
          class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
        />
      </div>
    ))}
  </div>

  <!-- Navigation Dots - Below Image -->
  {images.length > 1 && (
    <div class="flex justify-center gap-3 py-3" onclick="event.stopPropagation();">
      {images.map((_, index) => (
        <button
          class="product-carousel-dot h-2 rounded-full transition-all duration-300"
          data-index={index}
          data-active={index === 0 ? 'true' : 'false'}
          style={index === 0 ? 'width: 1.5rem; background-color: #D84315;' : 'width: 0.5rem; background-color: rgba(61, 61, 61, 0.3);'}
          aria-label={`View image ${index + 1}`}
        />
      ))}
    </div>
  )}
</div>

<script>
  class ProductImageCarousel {
    private container: HTMLElement;
    private images: NodeListOf<HTMLElement>;
    private dots: NodeListOf<HTMLElement>;
    private currentIndex: number = 0;

    constructor(container: HTMLElement) {
      this.container = container;
      this.images = container.querySelectorAll('.product-carousel-image');
      this.dots = container.querySelectorAll('.product-carousel-dot');

      this.init();
    }

    private init(): void {
      // Add click handlers to dots
      this.dots.forEach((dot, index) => {
        dot.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          this.goToSlide(index);
        });
      });
    }

    private goToSlide(index: number): void {
      if (index === this.currentIndex) return;

      // Hide current image
      this.images[this.currentIndex].classList.remove('opacity-100');
      this.images[this.currentIndex].classList.add('opacity-0');

      // Update current dot - make it small and inactive
      const currentDot = this.dots[this.currentIndex] as HTMLElement;
      currentDot.style.width = '0.5rem';
      currentDot.style.backgroundColor = 'rgba(61, 61, 61, 0.3)';
      currentDot.setAttribute('data-active', 'false');

      // Show new image
      this.images[index].classList.remove('opacity-0');
      this.images[index].classList.add('opacity-100');

      // Update new dot - make it large and active
      const newDot = this.dots[index] as HTMLElement;
      newDot.style.width = '1.5rem';
      newDot.style.backgroundColor = '#D84315';
      newDot.setAttribute('data-active', 'true');

      this.currentIndex = index;
    }
  }

  // Initialize all product carousels on the page
  document.addEventListener('DOMContentLoaded', () => {
    const carousels = document.querySelectorAll('[data-carousel-id]');
    const instances: ProductImageCarousel[] = [];

    carousels.forEach(carousel => {
      instances.push(new ProductImageCarousel(carousel as HTMLElement));
    });
  });
</script>

